machine:
  xcode:
    version: '8.3'
  environment:
    YARN_VERSION: 0.24.6
    # Needed for Android SDK installation bash script (see below)
    ANDROID_HOME: "/usr/local/Cellar/android-sdk"
    # PATH: "${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
    XCODE_SCHEME: 'Woodstock'
dependencies:
  pre:
    - brew install yarn
    - brew upgrade carthage
    - brew cask install fastlane
    - ./bin/bootstrap-if-needed.sh
    # Install Android SDK
    - ./bin/install-android-sdk.sh
  override:
    - yarn
    # The Android Gradle build will need the Android signing keystore keys setup
    - mkdir -p ~/.gradle
    - echo -e "SOFARSOUNDS_RELEASE_STORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD\nSOFARSOUNDS_RELEASE_KEY_PASSWORD=$ANDROID_KEYSTORE_PASSWORD" >> ~/.gradle/gradle.properties
    # Install Gems (fastlane, etc)
    # - bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3 --without development
    # Install node modules
    - yarn install
  cache_directories:
    # Let's speed up the next build by cacheing installed dependencies
    - ~/.yarn
    - ~/.cache/yarn
    - node_modules
    - ios/Carthage
deployment:
  beta:
    branch: master
    commands:      
      # Build and deploy Android app
      - cd android && fastlane android alpha
      # Build and deploy iOS app
      - cd ios && fastlane ios beta